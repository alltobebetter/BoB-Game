<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字游戏</title>
    <style>
        body {
            font-family: "SimSun", serif;
            background-color: #2a2a2a;
            color: #ffffff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 1;
        }

        .background-overlay.show {
            opacity: 1;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 2rem;
            z-index: 2;
            position: relative;
        }

        .character-name {
            font-size: 1.44rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dialog-text {
            font-size: 1.12rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.3s, transform 0.8s ease 0.3s;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            padding: 0 20px;
            min-height: 3em;
        }

        .options-container {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.6s, transform 0.8s ease 0.6s;
            flex-wrap: wrap;
        }

        .option-button {
            background: none;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem 2rem;
            font-size: 0.96rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            min-width: 150px;
        }

        .option-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .show {
            opacity: 1;
            transform: translateY(0);
        }

        #bgm-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        #bgm-control:hover {
            opacity: 1;
        }

        #bgm-control button {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        #bgm-control button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="background-overlay" id="background-overlay"></div>

    <div id="bgm-control">
        <audio id="bgm" loop>
            <source src="" type="audio/mpeg">
        </audio>
        <button onclick="toggleBGM()">音乐 开/关</button>
    </div>
    
    <div class="game-container">
        <div class="character-name" id="character-name"></div>
        <div class="dialog-text" id="dialog-text"></div>
        <div class="options-container" id="options-container"></div>
    </div>
    <script>
        let currentStory = {};
        let currentBranch = 'main';
        let currentLine = 0;
        let bgm = document.getElementById('bgm');
        let isAnimating = false;
        let isTyping = false;
        let typewriterSpeed = 50;

        async function loadStory() {
            try {
                const response = await fetch('readme.md');
                const text = await response.text();
                console.log("加载的原始文本:", text);
                currentStory = parseStory(text);
                console.log("解析后的故事数据:", currentStory);
                
                const savedProgress = localStorage.getItem('gameProgress');
                if (savedProgress) {
                    const progress = JSON.parse(savedProgress);
                    showContinuePrompt(progress.branch, progress.line);
                } else {
                    currentBranch = 'main';
                    currentLine = 0;
                    showCurrentLine();
                }
            } catch (error) {
                console.error('Error loading story:', error);
            }
        }

        function showContinuePrompt(savedBranch, savedLine) {
            const continuePrompt = {
                character: "旁白",
                dialog: "我们已经记录您的游戏进程，是否要继续",
                options: [
                    { text: "从本章继续", branch: savedBranch, line: savedLine },
                    { text: "重新开始", branch: "main", line: 0 }
                ],
                image: "",
                color: "#FFFFFF"
            };

            displayLine(continuePrompt);
        }

        function parseStory(text) {
            const branches = {};
            let currentBranch = 'main';
            
            const lines = text.split('\n').filter(line => line.trim());
            
            for (let line of lines) {
                if (line.startsWith('# ')) {
                    currentBranch = line.substring(2).trim();
                    branches[currentBranch] = [];
                    continue;
                }

                const match = line.match(/\[(.*?)\]\[(.*?)\](?:\[(.*?)\])?\[(.*?)\](?:\[(.*?)\])?/);
                if (match) {
                    const options = match[3] ? match[3].split('|').map(opt => {
                        if (opt.includes('*')) {
                            const [text, link] = opt.split('*');
                            return { text, link };
                        } else if (opt.includes('#')) {
                            const [text, branch] = opt.split('#');
                            return { text, branch };
                        }
                        return { text: opt };
                    }) : [];

                    branches[currentBranch].push({
                        character: match[1],
                        dialog: match[2],
                        options: options,
                        image: match[4].trim(),
                        color: match[5] ? match[5].trim() : '#FFFFFF'
                    });
                }
            }
            
            return branches;
        }

        function showCurrentLine() {
            if (!currentStory[currentBranch] || 
                currentLine >= currentStory[currentBranch].length) return;

            const line = currentStory[currentBranch][currentLine];
            displayLine(line);
            saveProgress();
        }

        function saveProgress() {
            localStorage.setItem('gameProgress', JSON.stringify({
                branch: currentBranch,
                line: currentLine
            }));
        }

        function typeWriter(element, text, callback) {
            let index = 0;
            isTyping = true;
            element.textContent = '';

            function type() {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                    setTimeout(type, typewriterSpeed);
                } else {
                    isTyping = false;
                    if (callback) callback();
                }
            }

            type();
        }

        function displayLine(line) {
            isAnimating = true;

            const characterElement = document.getElementById('character-name');
            const dialogElement = document.getElementById('dialog-text');
            const optionsContainer = document.getElementById('options-container');
            const backgroundOverlay = document.getElementById('background-overlay');

            characterElement.classList.remove('show');
            dialogElement.classList.remove('show');
            optionsContainer.classList.remove('show');
            backgroundOverlay.classList.remove('show');
            
            characterElement.textContent = line.character;
            dialogElement.textContent = '';
            
            // 设置文字颜色
            if (line.color) {
                dialogElement.style.color = line.color;
                characterElement.style.color = line.color;
            } else {
                dialogElement.style.color = '#FFFFFF';
                characterElement.style.color = '#FFFFFF';
            }
            
            if (line.image) {
                const img = new Image();
                img.onload = () => {
                    backgroundOverlay.style.backgroundImage = `url('${line.image}')`;
                    setTimeout(() => {
                        backgroundOverlay.classList.add('show');
                    }, 50);
                };
                img.onerror = () => {
                    console.error("图片加载失败:", line.image);
                };
                img.src = line.image;
            } else {
                backgroundOverlay.style.backgroundImage = 'none';
            }

            optionsContainer.innerHTML = '';

            requestAnimationFrame(() => {
                characterElement.classList.add('show');
                setTimeout(() => {
                    dialogElement.classList.add('show');
                    typeWriter(dialogElement, line.dialog, () => {
                        if (line.options && line.options.length > 0) {
                            line.options.forEach(option => {
                                const button = document.createElement('button');
                                button.className = 'option-button';
                                button.textContent = option.text;
                                if (line.color) {
                                    button.style.color = line.color;
                                    button.style.borderColor = line.color + '4D';
                                }
                                button.onclick = (e) => {
                                    e.stopPropagation();
                                    if (option.link) {
                                        window.location.href = option.link;
                                    } else if (option.branch) {
                                        currentBranch = option.branch;
                                        currentLine = option.line || 0;
                                        showCurrentLine();
                                    } else {
                                        currentLine++;
                                        showCurrentLine();
                                    }
                                };
                                optionsContainer.appendChild(button);
                            });
                            setTimeout(() => {
                                optionsContainer.classList.add('show');
                                isAnimating = false;
                            }, 300);
                        } else {
                            isAnimating = false;
                        }
                    });
                }, 300);
            });
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('#bgm-control')) return;
            if (e.target.closest('.option-button')) return;
            
            if (isTyping) {
                const dialogElement = document.getElementById('dialog-text');
                const currentLineData = currentStory[currentBranch][currentLine];
                dialogElement.textContent = currentLineData.dialog;
                isTyping = false;
                return;
            }
            
            if (!isAnimating && currentStory[currentBranch] && 
                currentLine < currentStory[currentBranch].length) {
                const currentOptions = currentStory[currentBranch][currentLine].options;
                if (!currentOptions || currentOptions.length === 0) {
                    currentLine++;
                    showCurrentLine();
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                if (isTyping) {
                    const dialogElement = document.getElementById('dialog-text');
                    const currentLineData = currentStory[currentBranch][currentLine];
                    dialogElement.textContent = currentLineData.dialog;
                    isTyping = false;
                    return;
                }

                if (!isAnimating && currentStory[currentBranch] && 
                    currentLine < currentStory[currentBranch].length) {
                    const currentOptions = currentStory[currentBranch][currentLine].options;
                    if (!currentOptions || currentOptions.length === 0) {
                        e.preventDefault();
                        currentLine++;
                        showCurrentLine();
                    }
                }
            }
        });

        function toggleBGM() {
            if (bgm.paused) {
                bgm.play();
            } else {
                bgm.pause();
            }
        }

        window.onload = loadStory;
    </script>
</body>
</html>