<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医院，护士还有无人的病房</title>
    <style>
        body {
            font-family: "SimSun", serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 1;
        }

        .background-overlay.show {
            opacity: 1;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 2rem;
            z-index: 2;
            position: relative;
        }

        .character-name {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dialog-text {
            font-size: 1.4rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.3s, transform 0.8s ease 0.3s;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            padding: 0 20px;
        }

        .options-container {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease 0.6s, transform 0.8s ease 0.6s;
            flex-wrap: wrap;
        }

        .option-button {
            background: none;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem 2rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            min-width: 150px;
        }

        .option-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .show {
            opacity: 1;
            transform: translateY(0);
        }

        #bgm-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        #bgm-control:hover {
            opacity: 1;
        }

        #bgm-control button {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        #bgm-control button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="background-overlay" id="background-overlay"></div>

    <div id="bgm-control">
        <audio id="bgm" loop>
            <source src="" type="audio/mpeg">
        </audio>
        <button onclick="toggleBGM()">音乐 开/关</button>
    </div>
    
    <div class="game-container">
        <div class="character-name" id="character-name"></div>
        <div class="dialog-text" id="dialog-text"></div>
        <div class="options-container" id="options-container"></div>
    </div>

    <script>
        let currentStory = [];
        let currentLine = 0;
        let bgm = document.getElementById('bgm');
        let isAnimating = false;

        async function loadStory() {
            try {
                const response = await fetch('readme.md');
                const text = await response.text();
                console.log("加载的原始文本:", text); // 调试日志
                currentStory = parseStory(text);
                console.log("解析后的故事数据:", currentStory); // 调试日志
                showCurrentLine();
            } catch (error) {
                console.error('Error loading story:', error);
            }
        }

        function parseStory(text) {
            return text.split('\n')
                .filter(line => line.trim())
                .map(line => {
                    console.log("正在处理行:", line); // 调试日志
                    const match = line.match(/\[(.*?)\]\[(.*?)\](?:\[(.*?)\])?\[(.*?)\]/);
                    if (match) {
                        const options = match[3] ? match[3].split('|').map(opt => {
                            const isContinue = opt.startsWith('&');
                            const hasCustomLink = opt.includes('*');
                            let text, link;
                            
                            if (hasCustomLink) {
                                [text, link] = opt.split('*');
                            } else {
                                text = opt.replace('&', '');
                            }

                            return {
                                text: text,
                                continue: isContinue,
                                customLink: link || null
                            };
                        }) : [];

                        const imagePath = match[4] ? match[4].trim() : '';
                        console.log("提取的图片路径:", imagePath); // 调试日志
                        
                        return {
                            character: match[1].replace('*', ''),
                            dialog: match[2].replace('*', ''),
                            options: options,
                            image: imagePath
                        };
                    }
                    return null;
                })
                .filter(item => item);
        }

        function showCurrentLine() {
            if (currentLine >= currentStory.length) return;
            isAnimating = true;

            const line = currentStory[currentLine];
            console.log("当前显示行:", line); // 调试日志

            const characterElement = document.getElementById('character-name');
            const dialogElement = document.getElementById('dialog-text');
            const optionsContainer = document.getElementById('options-container');
            const backgroundOverlay = document.getElementById('background-overlay');

            // 重置所有元素状态
            characterElement.classList.remove('show');
            dialogElement.classList.remove('show');
            optionsContainer.classList.remove('show');
            backgroundOverlay.classList.remove('show');
            
            // 更新内容
            characterElement.textContent = line.character;
            dialogElement.textContent = line.dialog;
            
            // 处理背景图片
            if (line.image && line.image.trim()) {
                console.log("正在设置背景图片:", line.image); // 调试日志
                const img = new Image();
                img.onload = () => {
                    console.log("图片加载成功"); // 调试日志
                    backgroundOverlay.style.backgroundImage = `url('${line.image}')`;
                    setTimeout(() => {
                        backgroundOverlay.classList.add('show');
                    }, 50);
                };
                img.onerror = () => {
                    console.error("图片加载失败:", line.image); // 调试日志
                };
                img.src = line.image;
            } else {
                backgroundOverlay.style.backgroundImage = 'none';
            }

            // 清空选项
            optionsContainer.innerHTML = '';

            // 添加选项
            if (line.options && line.options.length > 0) {
                line.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option.text;
                    button.onclick = (e) => {
                        e.stopPropagation();
                        if (option.continue) {
                            currentLine++;
                            showCurrentLine();
                        } else if (option.customLink) {
                            window.location.href = option.customLink;
                        } else {
                            window.location.href = `./${option.text}/index.html`;
                        }
                    };
                    optionsContainer.appendChild(button);
                });
            }

            // 触发动画
            requestAnimationFrame(() => {
                characterElement.classList.add('show');
                setTimeout(() => {
                    dialogElement.classList.add('show');
                    if (line.options && line.options.length > 0) {
                        setTimeout(() => {
                            optionsContainer.classList.add('show');
                            isAnimating = false;
                        }, 300);
                    } else {
                        isAnimating = false;
                    }
                }, 300);
            });
        }

        function toggleBGM() {
            if (bgm.paused) {
                bgm.play();
            } else {
                bgm.pause();
            }
        }

        // 点击事件处理
        document.addEventListener('click', (e) => {
            if (e.target.closest('#bgm-control')) return;
            if (e.target.closest('.option-button')) return;
            
            if (!isAnimating && currentLine < currentStory.length) {
                const currentOptions = currentStory[currentLine].options;
                if (!currentOptions || currentOptions.length === 0) {
                    currentLine++;
                    showCurrentLine();
                }
            }
        });

        // 键盘事件处理
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'Enter') {
                if (!isAnimating && currentLine < currentStory.length) {
                    const currentOptions = currentStory[currentLine].options;
                    if (!currentOptions || currentOptions.length === 0) {
                        e.preventDefault();
                        currentLine++;
                        showCurrentLine();
                    }
                }
            }
        });

        // 初始化加载
        window.onload = loadStory;
    </script>
</body>
</html>